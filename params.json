{"name":"OPL3 FPGA","tagline":"Reverse engineered SystemVerilog RTL version of the Yamaha OPL3 (YMF262) FM Synthesizer","body":"opl3_fpga\r\n=========\r\nReverse engineered SystemVerilog RTL version of the \r\n<a href=\"http://en.wikipedia.org/wiki/Yamaha_YMF262\">Yamaha OPL3 (YMF262)</a> FM Synthesizer.\r\nDesign is complete and working on the Digilent ZYBO board. The software needs a bit of cleaning up.\r\n\r\nHear it in action:\r\n* https://www.youtube.com/watch?v=KoSF4ZoDuRI\r\n* https://www.youtube.com/watch?v=i9vEKyJScYw\r\n\r\nEvery effort possible has been made to replicate, bit-true, the math of the original OPL3 chip. Several other very smart people put in a lot of work before me to get as close as possible this goal in software, and this FPGA design would not be possible without their work. Their efforts included <a href=\"https://docs.google.com/document/d/18IGx18NQY_Q1PJVZ-bHywao9bhsDoAqoIn1rIm42nwo/edit\">de-lidding the chip to extract the actual values out of the ROMs</a>. They're all over at http://forums.submarine.org.uk/phpBB/viewforum.php?f=9. You can follow the progression of some of the reverse engineering--it's quite interesting.\r\n\r\nThere are some differences between this version and the original chip in the external interface due to the hardware on\r\nthe board that I'm using. The design is targeted to the <a href=\"https://www.digilentinc.com/Products/Detail.cfm?Prod=ZYBO\">Digilent ZYBO board</a>\r\nwhich has the <a href=\"http://www.xilinx.com/products/silicon-devices/soc/zynq-7000.html\">Xilinx Zynq-7000\r\nSoC</a> containing an ARM dual-core Cortex-A9 and an FPGA. The board also has an \r\n<a href=\"http://www.analog.com/en/products/audio-video/audio-codecs/ssm2603.html#product-overview\">Analog Devices SSM2603\r\naudio codec</a> with dual 24-bit DACs. The interface to the CPU is AXI4-Lite\r\nand the interface to the DAC is I<sup>2</sup>S, matching the particular hardware I have to work with. These\r\ninterfaces are wrapped in the design and would be easy to swap out.\r\n\r\nThe original OPL3 chip used a 14.31818MHz master clock. The sample rate was 14.31818MHz/288 = 49.7159KHz, which is quite an interesting sample rate. With 36 operator slots, that gives 8 clocks to update each operator each sample (operator logic is\r\ntime-shared between slots).\r\n\r\nThe SSM2603 on the ZYBO uses 256x oversampling, and thus requires a master clock 256x the sample clock.\r\nI decided to use a single clock domain and keep the sample clock as close as possible to the original\r\nchip. The ZYBO provides the FPGA with an external clock of 125MHz. Using a mixed-mode clock manager (MMCM) in the FPGA,\r\nI'm able to synthesize a 12.727MHz clock from that, which divided by 256 gets me very close to the original\r\nsample rate at 49.7148KHz. Updating 36 operator slots using my slower master clock only gives me 7 clock\r\ncycles per sample instead of 8, but that's okay because I can stack tons of combinational logic up with\r\nfew pipeline registers with this slow clock speed and modern FPGA. The build meets timing with 53.1ns of slack (＠_＠;)\r\n\r\nAs far as software, so far I've ported over <a href=\"http://software.kvee.cz/imfplay/\">imfplay</a> from x86 DOS to the ARM running bare metal. It can playback .dro files captured in DOSBox while playing the original games. They are essentially OPL3 register writes using a 1000Hz timer tick (I used the built in timer in the ARM). The files are stored in an in-memory filesystem. The whole package including the FPGA bitstream, front stage boot loader, imfplay executable, and filesystem image can be built using one command and placed on an SD card.\r\n\r\nIn doing the project, I was very impressed with what the original chip designers were able to accomplish. They used some very clever techniques to squeeze maximum functionality out of very limited resources--particularly using the combination of an exponential lookup table and a log-sine lookup table to <a href=\"https://github.com/gtaylormb/opl3_fpga/blob/master/docs/opl3math/opl3math.pdf\">apply gain to the sine wave without the use of multipliers</a>, and the clever use of time sharing the operator resources among 36 slots.\r\n\r\nTools used are Modelsim, Vivado 2015.1, Octave (for sample analysis), and SVEditor (for SystemVerilog file editing).\r\n\r\n## Digital waveform images\r\nThese were produced by writing the actual binary output values of the operator logic in simulation to a file and plotting them using Octave.\r\n\r\nThe 6 basic unmodulated waveform outputs:\r\n\r\n<img src=\"http://i.imgur.com/ysmm3Sp.png?1\">\r\n\r\n<img src=\"http://i.imgur.com/ze8W5wU.png?1\">\r\n\r\n<img src=\"http://i.imgur.com/DHMkYkb.png?1\">\r\n\r\n<img src=\"http://i.imgur.com/t8UO1Xz.png?1\">\r\n\r\n<img src=\"http://i.imgur.com/0fmTRXg.png?1\">\r\n\r\n<img src=\"http://i.imgur.com/o1EIYDZ.png?1\">\r\n\r\n<img src=\"http://i.imgur.com/LKeYdRh.png?1\">\r\n\r\n<img src=\"http://i.imgur.com/5JEmWyz.png?1\">\r\n\r\nDemonstration of the envelope being applied (attack, decay, sustain, release):\r\n\r\n<img src=\"http://i.imgur.com/Of8oeui.png?1\">\r\n\r\nClose up of the attack phase:\r\n\r\n<img src=\"http://i.imgur.com/GVkxXhn.png?1\">\r\n\r\n## Vivado block design\r\n\r\n<img src=\"https://github.com/gtaylormb/opl3_fpga/blob/master/docs/block_design.png\">\r\n\r\n## Utilization in xc7z010:\r\n\r\n    +----------------------------+------+-------+-----------+-------+\r\n    |          Site Type         | Used | Fixed | Available | Util% |\r\n    +----------------------------+------+-------+-----------+-------+\r\n    | Slice LUTs                 | 7106 |     0 |     17600 | 40.38 |\r\n    |   LUT as Logic             | 7040 |     0 |     17600 | 40.00 |\r\n    |   LUT as Memory            |   66 |     0 |      6000 |  1.10 |\r\n    |     LUT as Distributed RAM |    0 |     0 |           |       |\r\n    |     LUT as Shift Register  |   66 |     0 |           |       |\r\n    | Slice Registers            | 9529 |     0 |     35200 | 27.07 |\r\n    |   Register as Flip Flop    | 9529 |     0 |     35200 | 27.07 |\r\n    |   Register as Latch        |    0 |     0 |     35200 |  0.00 |\r\n    | F7 Muxes                   |  888 |     0 |      8800 | 10.09 |\r\n    | F8 Muxes                   |  238 |     0 |      4400 |  5.41 |\r\n    +----------------------------+------+-------+-----------+-------+\r\n    \r\n    +-------------------+------+-------+-----------+-------+\r\n    |     Site Type     | Used | Fixed | Available | Util% |\r\n    +-------------------+------+-------+-----------+-------+\r\n    | Block RAM Tile    |    1 |     0 |        60 |  1.67 |\r\n    |   RAMB36/FIFO*    |    0 |     0 |        60 |  0.00 |\r\n    |   RAMB18          |    2 |     0 |       120 |  1.67 |\r\n    |     RAMB18E1 only |    2 |       |           |       |\r\n    +-------------------+------+-------+-----------+-------+\r\n    \r\n    +----------------+------+-------+-----------+-------+\r\n    |    Site Type   | Used | Fixed | Available | Util% |\r\n    +----------------+------+-------+-----------+-------+\r\n    | DSPs           |    1 |     0 |        80 |  1.25 |\r\n    |   DSP48E1 only |    1 |       |           |       |\r\n    +----------------+------+-------+-----------+-------+\r\n    \r\n## Serial command line interface\r\n\r\nI've added a simple command line interface for playing songs. \r\nSet your terminal to 115200 baud, 8-N-1.\r\n    \r\n    Welcome to the OPL3 FPGA\r\n    \r\n    Type 'help' for a list of commands\r\n    >ls\r\n    descent.dro 381376\r\n    doom_000.dro 73778\r\n    doom_001.dro 54434\r\n    doom_002.dro 81288\r\n    doom_035.dro 50934\r\n    doom_036.dro 58198\r\n    doom2_000.dro 16554\r\n    doom2_001.dro 74836\r\n    doom2_002.dro 115962\r\n    doom2_003.dro 162264\r\n    doom2_031.dro 45292\r\n    doom2_032.dro 54584\r\n    doom2.dro 47328\r\n    doom.dro 90077\r\n    duke3d.dro 136862\r\n    hexen.dro 122449\r\n    war_000.dro 120658\r\n    >play doom_000.dro\r\n    DRO 2.0 file \r\n    \r\n## Build/run instructions (Linux)\r\n1. If you want to add any .dro files, you may place them in software/opl3dro.\r\nThey will be included in the in-memory filesystem for playback.\r\n\r\n2. Source the Vivado and SDK settings so all the build tools are in your path.\r\nExample: \r\n\r\n        source /opt/Xilinx/Vivado/2015.1/settings64.sh\r\n        source /opt/Xilinx/SDK/2015.1/settings64.sh\r\n      \r\n3. Run 'make' to build the FPGA and software necessary to run the OPL3\r\nand create an SD card image.\r\n\r\n4. Copy the resulting BOOT.bin to an SD card, insert it into the ZYBO.\r\n\r\n5. Set JP5 to SD.\r\n\r\n6. Connect a USB cable to PROG/UART on the ZYBO. Power on the ZYBO. Your PC should detect the USB serial port device.\r\n\r\n7. Run a terminal program, use 115200 baud, 8-N-1.\r\n\r\n8. Reset the ZYBO by pressing PS-SRST. In your terminal you should see:\r\n\r\n        Welcome to the OPL3 FPGA\r\n\r\n        Type 'help' for a list of commands\r\n        >\r\n\r\nEnjoy!\r\n\r\n## Future work\r\nI'd really love to make the board appear as a USB peripheral when plugged into PC. If DOSBox/ScummVM could be made aware of the device, they could direct all OPL3 writes to the board. Digital PCM output could be made available as well.\r\n\r\nAnother idea is to port DOSBox/ScummVM directly to the ARM CPU on the board.\r\n\r\nLet me know if you have other ideas or are interested into doing either of these projects, I'll help out as much as I can.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}